<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Praktikum Generator</title>
    
    <!-- Favicon Setup -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
        /* Base Styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f3f4f6;
        }

        /* Textarea Styling */
        textarea {
            font-family: "Courier New", monospace;
            white-space: pre-wrap;
            tab-size: 2;
            max-width: 100%;
            word-wrap: break-word;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            background-color: #fff;
        }

        /* Drop Area */
        .drop-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.375rem;
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            background-color: #f9fafb;
            transition: all 0.2s ease;
        }

        .drop-area:hover, .drop-area.dragover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }

        /* Image Preview */
        .image-preview {
            margin-top: 0.5rem;
            min-height: 3rem;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 18rem;
            border-radius: 0.25rem;
            object-fit: contain;
        }

        /* Section Boxes */
        .section-box {
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background-color: #f8fafc;
        }

        .section-header {
            background-color: #dbeafe;
            padding: 0.5rem;
            border-radius: 0.375rem 0.375rem 0 0;
        }

        .subsection-box {
            border: 1px solid #94a3b8;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            background-color: #fff;
        }

        .subsection-header {
            background-color: #f1f5f9;
            padding: 0.5rem;
            border-radius: 0.25rem 0.25rem 0 0;
        }

        /* Utility Classes */
        .remove-btn {
            background-color: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        .latex-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 0.5rem;
            margin-top: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        .latex-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 0.5rem;
            margin-top: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        /* Animations */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Responsivitas */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .grid-cols-1.md\:grid-cols-2 {
                grid-template-columns: 1fr;
            }

            .section-box, .subsection-box {
                margin-bottom: 1.5rem;
            }

            .section-header, .subsection-header {
                flex-direction: column;
                gap: 0.5rem;
            }

            .section-header input, .subsection-header input {
                width: 100%;
            }

            .flex.justify-between.items-center {
                flex-direction: column;
                gap: 0.5rem;
            }

            .flex.gap-2 {
                width: 100%;
                justify-content: space-between;
            }

            button {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
    <div class="container max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-bold text-gray-800">Asisten Laprak</h2>
            <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                <div class="w-full md:w-auto">
                    <label for="file-select" class="block mb-1 font-medium text-gray-700">File Tersimpan:</label>
                    <select id="file-select" class="w-full md:w-64 border rounded p-2" onchange="loadFile()">
                        <option value="">-- Pilih file --</option>
                        {% for file in filenames %}
                            <option value="{{ file.filename if file is mapping else file }}"
                                    {% if form_data and form_data.filename == (file.filename if file is mapping else file) %}selected{% endif %}>
                                {{ file.nama ~ ' - ' ~ file.judul if file is mapping and file.nama and file.judul else (file.filename if file is mapping else file) }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <button type="button" onclick="window.location.href='/'" 
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                    Buat Baru
                </button>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="p-4 my-4 rounded-md flex justify-between items-center 
                        {% if category == 'error' %}bg-red-100 text-red-900{% else %}bg-green-100 text-green-900{% endif %}">
                        <span>{{ message }}</span>
                        <button onclick="this.parentElement.remove()" class="text-lg font-bold">×</button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Form -->
        <form method="POST" action="/" enctype="multipart/form-data" class="space-y-6 bg-white p-6 rounded-lg shadow-md" id="laporanForm">
            {% if form_data and form_data.filename %}
                <input type="hidden" name="edit_mode" value="true">
                <input type="hidden" name="original_filename" value="{{ form_data.filename }}">
            {% endif %}
            <input type="hidden" name="filename" id="filename" value="{{ form_data.filename if form_data else '' }}">

            <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block font-medium text-gray-700">Mata Kuliah</label>
                    <select name="matkul" id="matkul" required onchange="updateDosen()" 
                            class="w-full border rounded p-2">
                        <option value="">Pilih Mata Kuliah</option>
                        {% for matkul in matkul_dosen.keys() %}
                            <option value="{{ matkul }}" {% if form_data and form_data.matkul == matkul %}selected{% endif %}>
                                {{ matkul }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block font-medium text-gray-700">Pertemuan</label>
                    <input type="text" name="pertemuan" value="{{ form_data.pertemuan if form_data else '' }}" 
                           required class="w-full border rounded p-2">
                </div>
                <div>
                    <label class="block font-medium text-gray-700">Judul</label>
                    <input type="text" name="judul" value="{{ form_data.judul if form_data else '' }}" 
                           required class="w-full border rounded p-2">
                </div>
                <div>
                    <label class="block font-medium text-gray-700">Tanggal</label>
                    <input type="date" name="tanggal" value="{{ form_data.tanggal if form_data else '' }}" 
                           required class="w-full border rounded p-2">
                </div>
                <div>
                    <label class="block font-medium text-gray-700">Nama</label>
                    <input type="text" name="nama" value="{{ form_data.nama if form_data else 'Hafidz Rizqullah Prasetya' }}" 
                           readonly class="w-full border rounded p-2 bg-gray-100">
                </div>
                <div>
                    <label class="block font-medium text-gray-700">NPM</label>
                    <input type="text" name="npm" value="{{ form_data.npm if form_data else '24/535493/SV/24243' }}" 
                           readonly class="w-full border rounded p-2 bg-gray-100">
                </div>
                <div>
                    <label class="block font-medium text-gray-700">Kelas</label>
                    <input type="text" name="kelas" value="{{ form_data.kelas if form_data else 'PL2A1' }}" 
                           readonly class="w-full border rounded p-2 bg-gray-100">
                </div>
                <div>
                    <label class="block font-medium text-gray-700">Dosen Pengampu</label>
                    <input type="text" name="dosen" id="dosen" value="{{ form_data.dosen if form_data else '' }}" 
                           readonly class="w-full border rounded p-2 bg-gray-100">
                </div>
            </div>

            <!-- Tujuan -->
            <div>
                <label class="block font-medium text-gray-700">Tujuan Praktikum</label>
                <textarea name="tujuan" rows="4" required class="w-full" data-trim="true">{{ form_data.tujuan|trim if form_data and form_data.tujuan else '' }}</textarea>
                <div id="tujuan-error" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>

            <!-- Dasar Teori -->
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Dasar Teori</h2>
                    <button type="button" id="btn-add-dasar-teori"
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Tambah Section
                    </button>
                </div>
                <div id="dasar-teori-container" class="space-y-4"></div>
            </div>

            <!-- Hasil dan Pembahasan -->
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Hasil dan Pembahasan</h2>
                    <button type="button" id="btn-add-section"
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Tambah Section
                    </button>
                </div>
                <div id="sections-container" class="space-y-4"></div>
            </div>

            <!-- Kesimpulan -->
            <div>
                <label class="block font-medium text-gray-700">Kesimpulan</label>
                <textarea name="kesimpulan" id="kesimpulan" rows="4" required class="w-full" data-trim="true">{{ form_data.kesimpulan|trim if form_data and form_data.kesimpulan else '' }}</textarea>
                <div id="kesimpulan-error" class="text-red-600 text-sm mt-1 hidden"></div>
                <div class="mt-2 flex justify-end gap-2">
                    <button type="button" id="btn-convert-kesimpulan"
                            class="bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">
                        Convert to LaTeX
                    </button>
                </div>
            </div>

            <!-- Referensi -->
            <div>
                <label class="block font-medium text-gray-700">Daftar Pustaka</label>
                <textarea name="referensi" id="referensi" rows="4" class="w-full" data-trim="true">{{ form_data.referensi|trim if form_data and form_data.referensi else '' }}</textarea>
                <div id="referensi-error" class="text-red-600 text-sm mt-1 hidden"></div>
                <div class="mt-2 flex justify-end gap-2">
                    <button type="button" id="btn-convert-referensi"
                            class="bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">
                        Convert to LaTeX
                    </button>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end gap-4">
                <button type="submit" name="action" value="save" 
                        class="bg-yellow-600 text-white px-6 py-2 rounded hover:bg-yellow-700">
                    Simpan
                </button>
                <button type="submit" name="action" value="generate" 
                        class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                    Generate LaTeX
                </button>
            </div>
        </form>
    </div>

    <script>
        // Global Variables
        const dosenMap = {{ matkul_dosen|tojson|safe }};
        let sectionCounter = 0;
        let subsectionCounters = {};
        let dasarTeoriSectionCounter = 0;
        let projectFolder = "{{ form_data.filename if form_data else '' }}";

        // Update projectFolder saat filename berubah
        document.getElementById('filename')?.addEventListener('change', (e) => {
            projectFolder = e.target.value || 'temp';
            console.log('Updated projectFolder:', projectFolder);
        });

        // Utility Functions
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, char => map[char]);
        }

        function escapeLatex(text) {
            if (!text) return '';
            return text
                .replace(/\\/g, "\\textbackslash{}")
                .replace(/%/g, "\\%")
                .replace(/\$/g, "\\$")
                .replace(/#/g, "\\#")
                .replace(/_/g, "\\_")
                .replace(/{/g, "\\{")
                .replace(/}/g, "\\}")
                .replace(/&/g, "\\&")
                .replace(/\^/g, "\\^")
                .replace(/~/g, "\\textasciitilde{}");
        }

        function showLoading(message = "Processing...") {
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent mx-auto"></div>
                        <p class="mt-3 text-gray-700">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.remove();
        }

        function loadFile() {
            const select = document.getElementById('file-select');
            if (!select.value) return;
            if (window.location.pathname.includes('/edit/') && window.location.pathname.endsWith(select.value)) return;
            
            showLoading(`Loading ${select.value}...`);
            window.location.href = `/edit/${encodeURIComponent(select.value)}`;
        }

        function updateDosen() {
            const matkul = document.getElementById('matkul').value;
            document.getElementById('dosen').value = dosenMap[matkul] || '';
        }

        function cleanTextareaText(text) {
            if (!text) return '';
            text = text.trim();
            text = text.replace(/\n\s*\n+/g, '\n');
            return text;
        }

        function cleanLatexText(text) {
            if (!text) return '';
            text = text.trim();
            text = text.replace(/\n\s*\n+/g, '\n');
            text = text.replace(/(\\(?:begin|end)\{[^}]*\})\n+/g, '$1');
            text = text.replace(/(\n\s*\\item)/g, '\\item');
            return text;
        }

        // Dasar Teori Section
        function addDasarTeoriSection(id = null, title = '', content = '', image = '') {
            console.log(`addDasarTeoriSection called with id=${id}, title=${title}, content length=${content.length}, image=${image}`);
            dasarTeoriSectionCounter = id ? Math.max(dasarTeoriSectionCounter, parseInt(id)) : dasarTeoriSectionCounter + 1;
            const sectionId = id || dasarTeoriSectionCounter;
            const container = document.getElementById('dasar-teori-container');

            const sectionDiv = document.createElement('div');
            sectionDiv.id = `dasar_teori_section_${sectionId}`;
            sectionDiv.className = 'section-box';
            
            sectionDiv.innerHTML = `
                <div class="section-header flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <input type="hidden" name="dasar_teori_section_id_${sectionId}" value="${sectionId}">
                        <label class="font-semibold">Section:</label>
                        <input type="text" name="dasar_teori_section_title_${sectionId}" 
                               value="${escapeHtml(title) || `Bagian ${sectionId}`}" 
                               class="border rounded p-1 w-64" required>
                    </div>
                    <button type="button" id="btn-remove-dt-${sectionId}"
                            class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">
                        ×
                    </button>
                </div>
                <div class="p-4">
                    <label class="block font-medium mb-1">Konten</label>
                    <textarea name="dasar_teori_section_content_${sectionId}" id="dasar_teori_section_content_${sectionId}" rows="5" 
                              class="w-full font-mono" data-trim="true">${escapeHtml(content)}</textarea>
                    <div id="dasar_teori_section_content_${sectionId}-error" class="text-red-600 text-sm mt-1 hidden"></div>
                    <div class="mt-2 flex justify-end gap-2">
                        <button type="button" id="btn-convert-${sectionId}"
                                class="bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">
                            Convert to LaTeX
                        </button>
                    </div>
                    <div class="mt-4">
                        <label class="block font-medium mb-1">Gambar (opsional)</label>
                        <input type="hidden" name="dasar_teori_section_image_${sectionId}" 
                               id="dasar_teori_image_${sectionId}" value="${image}">
                        <div id="dasar_teori_drop_area_${sectionId}" class="drop-area">
                            <p>Paste gambar di sini (Ctrl+V)</p>
                            <div id="dasar_teori_preview_${sectionId}" class="image-preview">
                                ${image ? `
                                    <div class="relative">
                                        <img src="/get-image/${image}" alt="Preview" class="max-h-48 object-contain" onerror="this.src='/static/placeholder.png';">
                                        <button type="button" id="btn-remove-img-dt-${sectionId}"
                                                class="absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-700">
                                            ×
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(sectionDiv);
            setupDropArea(`dasar_teori_drop_area_${sectionId}`, `dasar_teori_image_${sectionId}`, `dasar_teori_preview_${sectionId}`);
            
            document.getElementById(`btn-remove-dt-${sectionId}`).addEventListener('click', () => removeDasarTeoriSection(sectionId));
            document.getElementById(`btn-convert-${sectionId}`).addEventListener('click', () => convertToLatex(sectionId, 'dasar_teori_section_content_'));
            
            if (image) {
                document.getElementById(`btn-remove-img-dt-${sectionId}`).addEventListener('click', () => 
                    removeImage(`dasar_teori_image_${sectionId}`, `dasar_teori_preview_${sectionId}`));
            }
            console.log(`Dasar Teori Section ${sectionId} added to DOM`);
        }

        function removeDasarTeoriSection(sectionId) {
            const section = document.getElementById(`dasar_teori_section_${sectionId}`);
            if (document.querySelectorAll('#dasar-teori-container .section-box').length <= 1) {
                alert('Minimal satu section dasar teori diperlukan.');
                return;
            }
            const sectionTitle = section.querySelector(`input[name="dasar_teori_section_title_${sectionId}"]`).value;
            if (confirm(`Hapus section "${sectionTitle}"? Semua konten dan gambar di dalamnya akan dihapus.`)) {
                const imageInput = section.querySelector(`#dasar_teori_image_${sectionId}`);
                if (imageInput?.value) deleteImageFromServer(imageInput.value);
                section.remove();
            }
        }

        // Main Sections
        function addSection(id = null, title = '') {
            console.log(`addSection called with id=${id}, title=${title}`);
            sectionCounter = id ? Math.max(sectionCounter, parseInt(id)) : sectionCounter + 1;
            const sectionId = id || sectionCounter;
            subsectionCounters[sectionId] = 0;
            const container = document.getElementById('sections-container');

            const sectionDiv = document.createElement('div');
            sectionDiv.id = `section_${sectionId}`;
            sectionDiv.className = 'section-box';
            sectionDiv.innerHTML = `
                <div class="section-header flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <input type="hidden" name="section_type_${sectionId}" value="section">
                        <label class="font-semibold">Section:</label>
                        <input type="text" name="section_title_${sectionId}" 
                               value="${escapeHtml(title) || `Latihan ${sectionId}`}" 
                               class="border rounded p-1 w-64" required>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" id="btn-add-sub-${sectionId}" 
                                class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                            + Subsection
                        </button>
                        <button type="button" id="btn-remove-section-${sectionId}"
                                class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">
                            ×
                        </button>
                    </div>
                </div>
                <div id="subsections_${sectionId}" class="p-4 space-y-4"></div>
            `;
            container.appendChild(sectionDiv);
            
            document.getElementById(`btn-add-sub-${sectionId}`).addEventListener('click', () => addSubsection(sectionId));
            document.getElementById(`btn-remove-section-${sectionId}`).addEventListener('click', () => removeSection(sectionId));
            
            if (!id) addSubsection(sectionId);
            console.log(`Main Section ${sectionId} added to DOM`);
        }

        function addSubsection(sectionId, id = null, title = '', code = '', image = '', penjelasan = '') {
            console.log(`addSubsection called with sectionId=${sectionId}, id=${id}, title=${title}, code length=${code.length}, image=${image}, penjelasan length=${penjelasan.length}`);
            subsectionCounters[sectionId] = subsectionCounters[sectionId] || 0;
            subsectionCounters[sectionId] = id ? Math.max(subsectionCounters[sectionId], parseInt(id.split('_')[1] || 0)) : subsectionCounters[sectionId] + 1;
            const subsectionId = id || `${sectionId}_${subsectionCounters[sectionId]}`;
            const container = document.getElementById(`subsections_${sectionId}`);

            const subsectionDiv = document.createElement('div');
            subsectionDiv.id = `subsection_${subsectionId}`;
            subsectionDiv.className = 'subsection-box';
            subsectionDiv.innerHTML = `
                <div class="subsection-header flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <input type="hidden" name="section_type_${subsectionId}" value="subsection">
                        <input type="hidden" name="parent_section_${subsectionId}" value="${sectionId}">
                        <label class="font-medium">Subsection:</label>
                        <input type="text" name="section_title_${subsectionId}" 
                               value="${escapeHtml(title) || `Soal ${subsectionId.split('_')[1]}`}" 
                               class="border rounded p-1 w-64" required>
                    </div>
                    <button type="button" id="btn-remove-sub-${subsectionId}"
                            class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">
                        ×
                    </button>
                </div>
                <div class="p-4 space-y-4">
                    <div>
                        <label class="block font-medium mb-1">Kode</label>
                        <textarea name="code_${subsectionId}" rows="5" class="w-full font-mono" data-trim="true">${escapeHtml(code)}</textarea>
                    </div>
                    <div>
                        <label class="block font-medium mb-1">Gambar</label>
                        <input type="hidden" name="image_${subsectionId}" id="image_${subsectionId}" value="${image}">
                        <div id="drop-area_${subsectionId}" class="drop-area">
                            <p>Paste gambar di sini (Ctrl+V)</p>
                            <div id="preview_${subsectionId}" class="image-preview">
                                ${image ? `
                                    <div class="relative">
                                        <img src="/get-image/${image}" alt="Preview" class="max-h-48 object-contain" onerror="this.src='/static/placeholder.png';">
                                        <button type="button" id="btn-remove-img-${subsectionId}"
                                                class="absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-700">
                                            ×
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block font-medium mb-1">Penjelasan</label>
                        <textarea name="penjelasan_${subsectionId}" id="penjelasan_${subsectionId}" rows="3" class="w-full" data-trim="true">${escapeHtml(penjelasan)}</textarea>
                        <div id="penjelasan_${subsectionId}-error" class="text-red-600 text-sm mt-1 hidden"></div>
                        <div class="mt-2 flex justify-end gap-2">
                            <button type="button" id="btn-convert-penjelasan-${subsectionId}"
                                    class="bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">
                                Convert to LaTeX
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(subsectionDiv);
            setupDropArea(`drop-area_${subsectionId}`, `image_${subsectionId}`, `preview_${subsectionId}`);
            
            document.getElementById(`btn-remove-sub-${subsectionId}`).addEventListener('click', () => removeSubsection(subsectionId));
            document.getElementById(`btn-convert-penjelasan-${subsectionId}`).addEventListener('click', () => convertToLatex(subsectionId, 'penjelasan_'));
            
            if (image) {
                document.getElementById(`btn-remove-img-${subsectionId}`).addEventListener('click', () => 
                    removeImage(`image_${subsectionId}`, `preview_${subsectionId}`));
            }
            console.log(`Subsection ${subsectionId} added to DOM`);
        }

        function removeSection(sectionId) {
            const section = document.getElementById(`section_${sectionId}`);
            if (document.querySelectorAll('#sections-container .section-box').length <= 1) {
                alert('Minimal satu section diperlukan.');
                return;
            }
            const sectionTitle = section.querySelector(`input[name="section_title_${sectionId}"]`).value;
            if (confirm(`Hapus section "${sectionTitle}" beserta semua subsection? Semua konten dan gambar di dalamnya akan dihapus.`)) {
                section.querySelectorAll('input[id^="image_"]').forEach(input => {
                    if (input.value) deleteImageFromServer(input.value);
                });
                section.remove();
                delete subsectionCounters[sectionId];
            }
        }

        function removeSubsection(subsectionId) {
            const subsection = document.getElementById(`subsection_${subsectionId}`);
            const sectionId = subsectionId.split('_')[0];
            const subsections = document.getElementById(`subsections_${sectionId}`).querySelectorAll('.subsection-box');
            if (subsections.length <= 1) {
                alert('Minimal satu subsection diperlukan per section.');
                return;
            }
            if (confirm('Hapus subsection ini?')) {
                const imageInput = subsection.querySelector(`#image_${subsectionId}`);
                if (imageInput?.value) deleteImageFromServer(imageInput.value);
                subsection.remove();
            }
        }

        // Image Handling
        function setupDropArea(dropAreaId, inputId, previewId) {
            const dropArea = document.getElementById(dropAreaId);
            if (!dropArea) {
                console.error(`Drop area not found: ${dropAreaId}`);
                return;
            }
            
            dropArea.tabIndex = 0;

            ['dragover', 'dragenter'].forEach(event => {
                dropArea.addEventListener(event, e => {
                    e.preventDefault();
                    dropArea.classList.add('dragover');
                });
            });

            ['dragleave', 'drop'].forEach(event => {
                dropArea.addEventListener(event, () => dropArea.classList.remove('dragover'));
            });

            dropArea.addEventListener('drop', e => {
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if (file?.type.startsWith('image/')) handleImageFile(file, previewId, inputId);
            });

            dropArea.addEventListener('paste', e => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let item of items) {
                    if (item.type.startsWith('image')) {
                        handleImageFile(item.getAsFile(), previewId, inputId);
                        e.preventDefault();
                        break;
                    }
                }
            });

            dropArea.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = e => {
                    if (e.target.files[0]) handleImageFile(e.target.files[0], previewId, inputId);
                };
                input.click();
            });
        }

        function handleImageFile(file, previewId, inputId) {
            if (!file.type.startsWith('image/')) {
                alert('File harus berupa gambar (jpg, png, dll).');
                return;
            }

            const maxSizeMB = 5;
            if (file.size > maxSizeMB * 1024 * 1024) {
                alert(`Ukuran file terlalu besar. Maksimum ${maxSizeMB}MB.`);
                return;
            }

            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById(previewId);
                preview.innerHTML = '<div class="text-center py-4">Uploading...</div>';
                uploadImageToServer(file, inputId, previewId);
            };
            reader.readAsDataURL(file);
        }

        function uploadImageToServer(file, inputId, previewId) {
            const formData = new FormData();
            formData.append('image', file);
            
            const currentProjectFolder = projectFolder || 'temp';
            formData.append('folder', currentProjectFolder);
            
            console.log('Uploading to project folder:', currentProjectFolder);
            
            fetch('/upload', { 
                method: 'POST', 
                body: formData 
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.filepath) {
                    console.log('Image uploaded successfully:', data);
                    document.getElementById(inputId).value = data.filepath;
                    
                    const preview = document.getElementById(previewId);
                    preview.innerHTML = `
                        <div class="relative">
                            <img id="${previewId}" src="/get-image/${data.filepath}" alt="Preview" class="max-h-48 object-contain" onerror="this.src='/static/placeholder.png';">
                            <button type="button" class="remove-image-btn absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-700" data-input="${inputId}" data-preview="${previewId}">
                                ×
                            </button>
                        </div>
                    `;
                    
                    const removeBtn = preview.querySelector('.remove-image-btn');
                    if (removeBtn) {
                        removeBtn.addEventListener('click', () => {
                            removeImage(inputId, previewId);
                        });
                    }
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            })
            .catch(error => {
                console.error('Upload failed:', error);
                document.getElementById(previewId).innerHTML = `<div class="text-red-600">Upload failed: ${error.message}</div>`;
            });
        }

        function removeImage(inputId, previewId) {
            const input = document.getElementById(inputId);
            if (input.value) deleteImageFromServer(input.value);
            input.value = '';
            document.getElementById(previewId).innerHTML = '';
        }

        function deleteImageFromServer(filename) {
            fetch('/delete_image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename, folder: projectFolder })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Image deleted successfully: ${filename}`);
                } else {
                    console.error(`Failed to delete image: ${data.error}`);
                }
            })
            .catch(error => console.error('Error deleting image:', error));
        }

        async function convertToLatex(id, prefix) {
            let textarea;
            let errorDiv;
            if (prefix === 'kesimpulan' || prefix === 'referensi') {
                textarea = document.getElementById(prefix);
                errorDiv = document.getElementById(`${prefix}-error`);
            } else {
                textarea = document.getElementById(`${prefix}${id}`);
                errorDiv = document.getElementById(`${prefix}${id}-error`);
            }

            if (!textarea) {
                console.error(`Textarea with ID ${prefix}${id} not found`);
                return;
            }

            if (!errorDiv) {
                console.warn(`Error div for ${prefix}${id} not found`);
                errorDiv = { classList: { add: () => {}, remove: () => {} }, innerText: '' };
            }

            if (!textarea.value.trim()) {
                errorDiv.innerText = 'Konten tidak boleh kosong';
                errorDiv.classList.remove('hidden');
                return;
            }

            showLoading('Converting to LaTeX...');
            try {
                const response = await fetch('/convert-to-latex', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: escapeLatex(textarea.value),
                        preserve: document.getElementById('preserve-format-toggle')?.checked || true
                    })
                });
                const data = await response.json();
                hideLoading();

                if (data.success && confirm('Terapkan hasil konversi?')) {
                    textarea.value = cleanLatexText(data.latex_text);
                    textarea.classList.add('latex-success');
                    setTimeout(() => textarea.classList.remove('latex-success'), 2000);
                    errorDiv.classList.add('hidden');
                } else if (!data.success) {
                    errorDiv.innerText = 'Gagal mengkonversi ke LaTeX: ' + (data.error || 'Unknown error');
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Conversion error:', error);
                hideLoading();
                errorDiv.innerText = 'Gagal mengkonversi ke LaTeX: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        document.getElementById('laporanForm').addEventListener('submit', (e) => {
            document.querySelectorAll('textarea[data-trim="true"]').forEach(textarea => {
                textarea.value = cleanTextareaText(textarea.value);
            });
            showLoading(e.submitter?.value === 'generate' ? 'Generating LaTeX...' : 'Saving...');
        });

        document.addEventListener('DOMContentLoaded', () => {
            try {
                document.querySelectorAll('textarea[data-trim="true"]').forEach(textarea => {
                    textarea.value = cleanTextareaText(textarea.value);
                });

                if (typeof updateDosen === 'function') {
                    updateDosen();
                } else {
                    console.warn('updateDosen function is not defined');
                }

                const btnAddDasarTeori = document.getElementById('btn-add-dasar-teori');
                const btnAddSection = document.getElementById('btn-add-section');
                const btnConvertKesimpulan = document.getElementById('btn-convert-kesimpulan');
                const btnConvertReferensi = document.getElementById('btn-convert-referensi');

                if (btnAddDasarTeori) {
                    btnAddDasarTeori.addEventListener('click', () => {
                        console.log('Button Tambah Dasar Teori clicked');
                        addDasarTeoriSection();
                    });
                } else {
                    console.error('Button with ID btn-add-dasar-teori not found');
                }

                if (btnAddSection) {
                    btnAddSection.addEventListener('click', () => {
                        console.log('Button Tambah Section clicked');
                        addSection();
                    });
                } else {
                    console.error('Button with ID btn-add-section not found');
                }

                if (btnConvertKesimpulan) {
                    btnConvertKesimpulan.addEventListener('click', () => convertToLatex('', 'kesimpulan'));
                } else {
                    console.error('Button with ID btn-convert-kesimpulan not found');
                }

                if (btnConvertReferensi) {
                    btnConvertReferensi.addEventListener('click', () => convertToLatex('', 'referensi'));
                } else {
                    console.error('Button with ID btn-convert-referensi not found');
                }

                console.log('Loading Dasar Teori Sections...');
                try {
                    {% if form_data and form_data.dasar_teori_sections %}
                        {% for id, section in form_data.dasar_teori_sections.items() %}
                            console.log('Adding Dasar Teori Section {{ id }} with title: {{ section.title|tojson }}');
                            addDasarTeoriSection(
                                {{ id|tojson }},
                                {{ section.title|tojson }},
                                {{ section.content|trim|tojson }},
                                {{ section.image|tojson }}
                            );
                        {% endfor %}
                    {% else %}
                        console.log('No Dasar Teori sections found, adding default');
                        addDasarTeoriSection();
                    {% endif %}
                } catch (sectionError) {
                    console.error('Error loading Dasar Teori Sections:', sectionError);
                }

                console.log('Loading Main Sections...');
                try {
                    {% if form_data and form_data.main_sections %}
                        {% for id, section in form_data.main_sections.items() %}
                            {% if section.type == 'section' %}
                                console.log('Adding Main Section {{ id }} with title: {{ section.title|tojson }}');
                                addSection(
                                    {{ id|tojson }},
                                    {{ section.title|tojson }}
                                );
                                {% for sub_id, sub_section in form_data.main_sections.items() %}
                                    {% if sub_section.type == 'subsection' and sub_section.parent_section == id %}
                                        console.log('Adding Subsection {{ sub_id }} to Section {{ id }} with title: {{ sub_section.title|tojson }}');
                                        addSubsection(
                                            {{ id|tojson }},
                                            {{ sub_id|tojson }},
                                            {{ sub_section.title|tojson }},
                                            {{ sub_section.code|trim|tojson }},
                                            {{ sub_section.image|tojson }},
                                            {{ sub_section.penjelasan|trim|tojson }}
                                        );
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        console.log('No Main sections found, adding default');
                        addSection();
                    {% endif %}
                } catch (sectionError) {
                    console.error('Error loading Main Sections:', sectionError);
                }

                console.log('Project folder:', projectFolder);
                document.querySelectorAll('img').forEach(img => {
                    img.onerror = function() {
                        console.error('Image failed to load:', this.src);
                        this.src = '/static/placeholder.png';
                    };
                });
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        });
    </script>
</body>
</html>